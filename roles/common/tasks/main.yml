- name: "Setup configuration directories"
  file:
    dest: "{{ lookup('env','HOME') }}/{{ item }}"
    state: directory
  with_items:
    - .config
    - .config/autostart
    - .config/Code/User
    - .config/systemd/user
    - .ssh
    - .local/bin
    - .virtualenvs
    - .gnupg
    - .FreeCAD
    - .local/share
    - .fonts
- name: "Install dotfiles"
  file:
    src: "{{ playbook_dir }}/dotfiles/{{ item.src }}"
    dest: "{{ lookup('env','HOME') }}/{{ item.dest }}"
    state: link
    force: yes
  with_items:
    - src: gitconfig
      dest: .gitconfig
    - src: gitignore
      dest: .gitignore
    - src: fdignore
      dest: .fdignore
    - src: config/nvim
      dest: .config/nvim
    - src: config/alacritty
      dest: .config/alacritty
    - src: config/Code/User/keybindings.json
      dest: .config/Code/User/keybindings.json
    - src: config/autostart/gnome-keyring-ssh.desktop
      dest: .config/autostart/gnome-keyring-ssh.desktop
    - src: gnupg/gpg.conf
      dest: .gnupg/gpg.conf
    - src: gnupg/gpg-agent.conf
      dest: .gnupg/gpg-agent.conf
    - src: bashrc
      dest: .bashrc
    - src: inputrc
      dest: .inputrc
    - src: profile
      dest: .profile
    - src: tmux.conf
      dest: .tmux.conf
    - src: Xresources
      dest: .Xresources
    - src: FreeCAD/Macro
      dest: .FreeCAD/Macro
    - src: ideavimrc
      dest: .ideavimrc
    - src: sbclrc
      dest: .sbclrc
- name: "Install local scripts"
  file:
    src: "{{ item }}"
    dest: "{{ lookup('env','HOME') }}/.local/bin/{{ item | basename }}"
    state: link
    force: yes
  with_fileglob:
    - "{{ playbook_dir }}/bin/*"
- name: ssh-config
  template:
    src: templates/ssh-config
    dest: "{{ lookup('env','HOME') }}/.ssh/config"
- name: Install apt transport https
  become: yes
  apt:
    name: apt-transport-https
- name: Update apt packages
  become: yes
  apt:
    upgrade: dist
    update_cache: yes
- name: Install apt packages
  become: yes
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - bison
    - build-essential
    - cowsay
    - curl
    - fd-find
    - flatpak
    - flex
    - fzf
    - gdb-multiarch
    - git
    - gnupg2
    - htop
    - libssl-dev
    - openssh-server
    - pcscd
    - pkg-config
    - python3-pip
    - python3-venv
    - ripgrep
    - ruby
    - ruby-bundler
    - ruby-dev
    - scdaemon
    - shellcheck
    - sl
    - sshpass
    - tmux
    - tree
    - xclip
- name: Remove apt packages
  become: yes
  apt:
    name: "{{ packages }}"
    state: absent
  vars:
    packages:
    - elixir
    - evolution
    - krita
- name: Download neovim
  get_url:
    url: https://github.com/neovim/neovim/releases/download/v0.8.0/nvim-linux64.deb
    checksum: sha256:215c88e8cf3fefcd02ef45dc8cdad563e1c601faeddca41565b6b852fceb26b5
    dest: "{{ lookup('env','HOME') }}/.local/share/neovim.deb"
  register: neovim_dl
- name: Install neovim
  become: yes
  apt:
    deb: "{{ neovim_dl.dest }}"
  when: neovim_dl.changed
- name: Install python packages
  pip:
    name: "{{ packages }}"
    executable: pip3
    extra_args: --user
    state: latest
  vars:
    packages:
      - black
      - neovim
      - poetry
      - pre-commit
      - pylama
      - pylint
      - pyright
      - virtualenv
- name: Setup neovim virtualenv Python 3
  pip:
    name: pynvim
    virtualenv: "{{ lookup('env', 'HOME') }}/.virtualenvs/neovim-py3"
    virtualenv_python: python3
- name: Add jedi to neovim virtualenv
  pip:
    name: jedi
    virtualenv: "{{ lookup('env', 'HOME') }}/.virtualenvs/neovim-py3"
- name: Download insect
  get_url:
    url: https://github.com/sharkdp/insect/releases/download/v5.7.0/insect-linux-x64
    checksum: sha256:38d0971342c741bcc688416059ad936b371d4fc5f74883a4369952b1ff4e3b02.
    dest: "{{ lookup('env','HOME') }}/.local/bin/insect"
- name: Chmod insect
  file:
    path: "{{ lookup('env','HOME') }}/.local/bin/insect"
    mode: a+x
- name: Add the flathub flatpak repository remote to the user installation
  become: yes
  community.general.flatpak_remote:
    name: flathub
    state: present
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
- name: Download difftastic
  get_url:
    url: https://github.com/Wilfred/difftastic/releases/download/0.36.1/difft-x86_64-unknown-linux-gnu.tar.gz
    checksum: sha256:4acc8dbd23a8e61d4f2dad94dba98cb2d9d5b2a9c7c12f22a78d2ce841707524
    dest: "{{ lookup('env','HOME') }}/.local/share/difft.tar.gz"
  register: difft_dl
- name: Extract difftastic
  ansible.builtin.unarchive:
    src: "{{ difft_dl.dest }}"
    dest: "{{ lookup('env','HOME') }}/.local/bin/"
  when: difft_dl.changed
