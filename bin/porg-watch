#!/usr/bin/env python3
import toml
import pathlib
import subprocess


def run_one():
    name = toml.loads(pathlib.Path("pyproject.toml").read_text())["tool"]["poetry"][
        "name"
    ]

    cmd(
        [
            "inotifywait",
            "-e",
            "modify",
            "-e",
            "create",
            "-r",
            "pyproject.toml",
            "test",
            name,
        ]
    )

    try:
        cmd(["porg", "format"])
        cmd(["porg", "test"])
        cmd(["porg", "check"])
    except subprocess.CalledProcessError:
        print("FAILED")


def cmd(command):
    print(" >>> " + " ".join(command))
    subprocess.check_call(command)


try:
    while True:
        run_one()
except KeyboardInterrupt:
    pass
